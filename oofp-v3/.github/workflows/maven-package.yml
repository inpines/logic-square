name: Publish Maven Package

on:
  push:
    tags:
      - 'v*'
    branches:
      - develop
  pull_request:

jobs:
  build:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven
      - name: Build (no deploy)
        run: mvn -B -U -DskipTests verify

  publish:
    if: github.event_name == 'push' &&
      (startsWith(github.ref, 'refs/tags/v') ||
      github.ref == 'refs/heads/develop')
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Configure Maven settings.xml
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<EOF
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.GITHUB_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF

      # tag → release
      - name: Set release version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          mvn -B -U versions:set \
            -DnewVersion="$VERSION" \
            -DgenerateBackupPoms=false

      # develop → snapshot（不用 exec plugin）
      - name: Ensure snapshot version on develop
        if: github.ref == 'refs/heads/develop'
        run: |
          CURR=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          case "$CURR" in
            *-SNAPSHOT)
              echo "Already SNAPSHOT: $CURR"
              ;;
            *)
              mvn -B -U versions:set \
                -DnewVersion="${CURR}-SNAPSHOT" \
                -DgenerateBackupPoms=false
              ;;
          esac

      # release gate
      - name: Fail if release is SNAPSHOT
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          echo "project.version=$VERSION"
          case "$VERSION" in
            *-SNAPSHOT)
              echo "❌ Release tag must not deploy SNAPSHOT"
              exit 1
              ;;
            *)
              echo "✅ Release version OK"
              ;;
          esac

      - name: Build & Deploy
        run: mvn -B -U -Pgithub-deploy -DskipTests deploy
