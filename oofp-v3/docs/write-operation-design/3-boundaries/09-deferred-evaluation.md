# 延後運算（Deferred Evaluation）：宣告式模型的共同基礎

在前面的章節中，我們分別討論了：

- `WriteOperation` 作為行為語言
- `Conditional Rules` 作為可組合的 `predicate`
- `GeneralBuilder` 作為物件建構語法
- `TransformStep / BehaviorStep` 作為行為轉換語法
- `Pipeline` 作為時間性承載器

如果只看這些角色的表面差異，
很容易誤以為它們分屬不同層級、不同階段。

但事實上，這套設計有一個**共同且關鍵的基礎**：

> **它們全部都是延後運算（deferred evaluation）的宣告式寫法。**

本章的目的，就是把這個共同模型明確寫出來。

---

## 什麼是「延後運算」

在這份文件中，「延後運算」並不是指效能技巧，
也不是 `lazy loading` 的實作細節。

它指的是一種設計立場：

> **程式碼描述的不是「現在做什麼」，  
> 而是「在什麼情境下，應該如何行為」。**

換句話說：

- 宣告的是「可能的行為」
- 而不是立即發生的副作用

---

## `WriteOperation`：延後的狀態改變描述

`WriteOperation` 本身就是延後運算的最小單位。

它描述的是：

- 如果被觸發
- 在符合其條件的情況下
- 對 target 產生什麼改變

它不關心：
- 何時觸發
- 是否一定會觸發
- 是否位於哪個流程中

因此 `WriteOperation` 永遠只是：
> **一段尚未發生的行為描述。**

---

## `Conditional Rules`：延後的行為修飾

條件式（`predicate`）並不是「先被算完的判斷」，
而是與 `WriteOperation` 一起被攜帶的語意修飾。

在這套模型中：

- 條件不會在建構時消失
- 條件不會被提前求值
- 條件會隨 `writer` 一起被組合、傳遞、延後

這代表：

> **行為的存在與否，  
> 並不是在某個時間點被「決定」，  
> 而是在實際觸發時被「展現」。**

---

## `GeneralBuilder`：延後的物件建構宣告

`GeneralBuilder` 常被誤解為「做事的地方」，
但在這套設計中，它同樣是延後運算。

它描述的是：

- 一個新物件應該如何被組合
- 使用哪些構件
- 這些構件如何攜帶行為與條件

但它不：

- 觸發任何行為
- 改變任何 context
- 評估任何 predicate

`GeneralBuilder` 的產物，
仍然只是「尚未發生任何效果的描述」。

---

## `TransformStep`：延後的行為轉換宣告

`TransformStep` 的角色，
同樣不是立即執行，
而是描述：

> **當 Pipeline 執行到此時，  
> context 應該如何被轉換。**

即使在 `TransformStep` 中呼叫了 writer，
它仍然是被包在：

`StepContext<T> -> Validation<Violations, StepContext<T>>`

這個宣告式轉換模型之中。

`TransformStep` 並不主動執行，
它等待被 `Pipeline` 觸發。

---

## `Pipeline`：延後運算的實際展開點

在整套設計中，
`Pipeline` 是少數真正「讓事情發生」的地方。

但即便如此：

- `Pipeline` 本身仍然不定義行為
- 只負責依序展開已宣告的轉換
- 並在失敗時停止展開

可以說：

> **Pipeline 只是延後運算的展開器（`unfolder`），  
> 而不是決策者。**

---

## 為什麼整套設計必須一致地延後

如果其中任何一個角色開始：

- 提前求值條件
- 立即改變狀態
- 動態生成語意

整套模型就會破裂。

後果通常是：

- 宣告式與命令式混用
- 行為難以推理
- 抽象角色開始漂移

一致的延後運算，
正是讓這套設計能長期維持清晰的原因。

---

## 一個統一的判斷準則

在設計或實作時，可以用這個問題檢查：

> **我現在寫的是「描述規則」，  
> 還是「立即發生效果」？**

- 前者 → 屬於這套設計的核心模型
- 後者 → 應該被限制在 `Pipeline` 展開的最末端

---

## 一句話總結

> **這套設計不是在控制流程，  
> 而是在累積描述；  
> 真正的行為，只在最後一刻才發生。**

只要這個原則被守住，
`GeneralBuilder`、`WriteOperation`、`TransformStep`、`Pipeline`
就能各自站在正確的位置上。
