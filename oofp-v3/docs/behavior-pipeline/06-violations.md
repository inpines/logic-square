# Violations（錯誤模型與後處理）

本章專注於 Behavior Pipeline 中的錯誤模型：`Violations`。
重點不在於「怎麼拋錯」，而在於**錯誤如何被描述、累積、篩選，並轉化為決策**。

---

## 1. 錯誤在 Behavior Pipeline 中的定位

在這套設計中，錯誤不是流程的例外情況，而是流程的**產物**。

> **流程不是因為錯誤而失控，而是因為錯誤沒有被模型化。**

`Violations` 的存在目的，是讓錯誤能夠：
- 被累積
- 被觀察
- 被延後處理
- 被轉換為不同層級的決策

---

## 2. Violations 是集合，不是事件

### 2.1 為什麼不是單一錯誤？

實務場景中常見需求包括：

- 一次回報多個欄位錯誤
- 區分提醒（warning）與阻斷（severe）
- 同一流程中來自不同 Step 的問題

若錯誤被設計為單一事件：
- 後發錯誤會覆蓋前者
- 無法保留完整脈絡
- 流程只能 fail-fast

因此 `Violations` 被設計為**集合模型**。

---

### 2.2 可 join 的錯誤集合

Violations 具備 `join` 語意：

- 新錯誤加入既有集合
- 相同的 violation 不重複加入
- 每個 Step 只關心自己產生的錯誤

這使得錯誤的責任分散、決策集中。

---

## 3. GeneralViolation：錯誤的語意單位

### 3.1 一筆錯誤包含什麼？

`GeneralViolation` 不是一段字串，而是一筆具備結構的資料：

- **validationName**：錯誤分類與來源
- **stepName**：發生在哪個流程節點
- **messages**：一或多則描述
- **options**：嚴重度、警告標記等輔助資訊

這讓錯誤可以被：
- 分類
- 聚合
- 過濾
- 格式化

---

### 3.2 為什麼需要 stepName？

stepName 的目的不是 debug，而是：

> **讓錯誤回到「流程語境」中被理解。**

它可以用於：
- 顯示錯誤發生的流程階段
- 分析哪個 Step 最常產生問題
- 做流程品質監控

---

## 4. 嚴重度（Severity）的角色

### 4.1 嚴重度是資訊，不是指令

severity 用於表達：

- 問題的影響程度
- 對使用者或系統的風險

但它**不會自動影響流程**。

重要原則：

> **severity 提供判斷依據，但不代替判斷本身。**

---

### 4.2 常見嚴重度層級

實務上常見分級包括：

- **warning**：提醒性問題
- **severe**：重大問題
- **fatal**（若使用）：不可繼續的狀態

是否中斷流程，仍由 Pipeline 或顯式 Step 決定。

---

## 5. Violations 的後處理（Post-Processing）

### 5.1 為什麼需要後處理？

錯誤在產生當下，通常還不知道：

- 是否要全部回傳
- 是否要忽略部分錯誤
- 哪些錯誤對當前情境重要

因此錯誤決策被延後到流程結尾。

---

### 5.2 ViolationFilters 的角色

`ViolationFilters` 提供標準化的錯誤過濾策略，例如：

- **keepAll**：保留所有錯誤
- **dropAll**：忽略所有錯誤
- **onlySevere**：只保留重大錯誤
- **ignoreWarnings**：忽略警告型錯誤

這些策略讓錯誤處理：
- 可組合
- 可替換
- 可重用

---

### 5.3 過濾與流程的關係

過濾錯誤 **不等於改變流程歷史**：

- 原始 Violations 仍然存在於 Context
- 過濾僅影響最終輸出或決策
- 不應在流程中途破壞錯誤資訊

---

## 6. Violations 與 Validation 的銜接

### 6.1 流程內與流程外的差異

- **流程內**：Violations 是狀態的一部分
- **流程外**：Violations 成為結果的一部分

Pipeline 結尾會依策略：

- 將 Violations 轉成 Validation.invalid
- 或忽略錯誤，回傳成功結果

---

### 6.2 結果轉換的責任

錯誤如何呈現（API response、UI message、log）：

- 不屬於 Step
- 不屬於 Pipeline
- 屬於應用層或輸出層

這保持 DSL 的中立性。

---

## 7. 常見誤用與風險

### 7.1 把 Violations 當 log 使用

Violations 應描述「問題」，不是「發生過什麼事」。

過度記錄會：
- 模糊錯誤語意
- 增加後處理成本

---

### 7.2 在 Step 中過早決策錯誤

例如：
- 看到 severe 就 aborted
- 看到 warning 就忽略後續錯誤

這會破壞「錯誤延後決策」的設計原則。

---

### 7.3 在流程中刪除錯誤

錯誤一旦產生，就應被保留到流程結尾，
過早刪除會造成資訊遺失。

---

## 8. 設計建議（Guidelines）

- Violations 用於描述問題，不用於控制流程
- 錯誤產生與錯誤決策應分離
- 嚴重度只提供資訊，不做隱性判斷
- 錯誤過濾應集中在流程結尾

---

## 9. 本章小結

- **Violations 是流程問題的完整紀錄**
- **GeneralViolation 提供錯誤語意結構**
- **Severity 是決策輔助，而非流程指令**
- **後處理讓錯誤決策延後且集中**

---

> **當錯誤被正確對待，流程才有真正的彈性。**

下一章將整理實務中可遵循的設計規約與最佳實踐。
