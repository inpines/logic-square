
---

# ğŸ“˜ `CH5 â€” å‰¯ä½œç”¨è¨­è¨ˆï¼šç‚ºä»€éº¼ç¦æ­¢åŒ¿å lambdaï¼Ÿ`

å®Œæ•´æŠ€è¡“ç‰ˆ

---

# 5.1 ä»€éº¼æ˜¯å‰¯ä½œç”¨ï¼ˆSide Effectï¼‰ï¼Ÿ

å‰¯ä½œç”¨ä¸æ˜¯å£äº‹ï¼Œå®ƒæ˜¯å¿…è¦çš„ï¼š

- auditï¼ˆå¯©è¨ˆï¼‰
    
- loggingï¼ˆè¨˜éŒ„ï¼‰
    
- metricsï¼ˆç›£æ§ï¼‰
    
- publishing eventï¼ˆäº‹ä»¶ç™¼å¸ƒï¼‰
    
- notifyï¼ˆé€šçŸ¥ï¼‰
    
- ä¿®æ”¹è³‡æ–™åº«
    
- å‘¼å«å¤–éƒ¨ç³»çµ±ï¼ˆemailã€smsï¼‰
    

ä½†å‰¯ä½œç”¨çš„æœ¬è³ªæ˜¯ï¼š

> **å°å¤–éƒ¨ä¸–ç•Œé€ æˆå½±éŸ¿çš„è¡Œç‚ºï¼Œä¸”ä¸åœ¨ç´”ç²¹è³‡æ–™æµï¼ˆpayload â†’ payloadï¼‰çš„èªæ„ä¹‹å…§ã€‚**

åœ¨ç´” FP ä¸–ç•Œï¼Œå‰¯ä½œç”¨é€šå¸¸è¢«é™åˆ¶æˆ–å°è£ï¼›  
åœ¨ä¼æ¥­ç³»çµ±ä¸–ç•Œï¼Œæˆ‘å€‘ç„¡æ³•é¿é–‹å‰¯ä½œç”¨ï¼Œä½†**å¯ä»¥å®šç¾©è¦ç¯„**ã€‚

---

# 5.2 å‰¯ä½œç”¨çš„æ­£ç¢ºä½ç½®åœ¨å“ªè£¡ï¼Ÿ

åœ¨ Monad pipeline ä¸­ï¼Œå‰¯ä½œç”¨æ‡‰è©²å­˜åœ¨æ–¼ï¼š

### âœ” `peek`ï¼ˆæˆåŠŸå‰¯ä½œç”¨ï¼‰

```java
.peek(this::auditSuccess)
```

### âœ” `peekError`ï¼ˆå¤±æ•—å‰¯ä½œç”¨ï¼‰

```java
.peekError(this::auditFailure)
```

### âœ” å–®ç¨çš„ Stepï¼Œè² è²¬ç”¢ç”Ÿå‰¯ä½œç”¨

```java
.flatMap(this::recordAuditEvent)
```

é€™ä¸‰å€‹ä½ç½®æ˜¯ **å”¯ä¸€å…è¨±å‰¯ä½œç”¨å­˜åœ¨çš„ä½ç½®**ã€‚

åŸå› åœ¨æ–¼ï¼š

- é€™äº›ä½ç½®**ä¸æœƒæ”¹è®Š Monad çš„æˆåŠŸæˆ–éŒ¯èª¤çµæœ**
    
- pipeline çš„è³‡æ–™æµä¿æŒç´”ç²¹
    
- æ§åˆ¶æµä¿æŒå¯é æ¸¬
    
- Step æœ¬èº«ç¶­æŒæœ€å°è²¬ä»»ï¼ˆsingle responsibilityï¼‰
    

---

# 5.3 ç‚ºä»€éº¼åŒ¿å lambda æœƒç ´å£å‰¯ä½œç”¨çš„èªæ„ï¼Ÿ

ä½ åŸå§‹æ–‡ä»¶ä¸­çš„è¦ç¯„éå¸¸é‡è¦ï¼š  
**å‰¯ä½œç”¨ä¸èƒ½å¯«æˆåŒ¿å lambdaï¼Œå¿…é ˆä½¿ç”¨å…·åæ–¹æ³•ã€‚**

é€™ä¸¦ä¸æ˜¯ã€Œç¨‹å¼é¢¨æ ¼åå¥½ã€ï¼Œè€Œæ˜¯**æ·±å±¤èªæ„è¦ç¯„**ã€‚

---

## 5.3.1 åŒ¿å lambda çš„å•é¡Œ 1ï¼šæ··æ·†ä¸»æµç¨‹

ä¾‹å¦‚ï¼š

```java
.peek(v -> log.info("saved: {}", v))
```

çœ‹èµ·ä¾† harmlessï¼Œä½†å¯¦éš›ä¸Šï¼š

- éš±è—äº†å‰¯ä½œç”¨
    
- ç„¡æ³•åœ¨ pipeline ä¸­ä¸€çœ¼çœ‹å‡ºè¡Œç‚ºç›®çš„
    
- ç ´å£ Step çš„èªæ„ä¸€è‡´æ€§ï¼ˆStep æ˜¯å¯çµ„åˆçš„ï¼Œlambda å»æ˜¯ä¸å¯è¿½è¹¤çš„ï¼‰
    

åä¾‹ï¼š

```java
.peek(this::logSavedRecord)
```

é€™å°±èƒ½ç«‹å³è¡¨é”ï¼š

- è¡Œç‚ºæ˜¯ logging
    
- å¯æŠ½æ›
    
- å¯é—œé–‰
    
- å¯ mock
    
- å¯æ¸¬è©¦
    
- å¯è¢«æ¶æ§‹å±¤çµ±ä¸€æƒæå¾ŒæŠ½å–ï¼ˆä¾‹å¦‚ log æ””æˆªå™¨ï¼‰
    

---

## 5.3.2 åŒ¿å lambda çš„å•é¡Œ 2ï¼šåŸ‹è—ä¸å¯è¦‹é‚è¼¯

åŒ¿å lambda å¯ä»¥æŠŠå¾ˆå¤šå‹•ä½œå¯«åœ¨è£¡é¢ï¼š

```java
.peek(v -> {
    log.info("done");
    metrics.counter("SAVE_OK").increment();
    notifyService.send(...);
})
```

é€™ç­‰æ–¼æŠŠå‰¯ä½œç”¨ã€Œå¡é€²ä¸é€æ˜çš„é»‘ç›’ã€ï¼Œ  
å®Œå…¨ç ´å£ä½ åœ¨ CH3ã€CH4 è¨­è¨ˆçš„ï¼š

> **æµç¨‹æ‡‰è©²æ˜¯ä¸€æ¢é¡¯å¼å¯é–±è®€çš„ç·šã€‚**

ä½¿ç”¨å…·åæ–¹æ³•ï¼š

```java
.peek(this::onSaveSuccess)
```

ä¸¦åœ¨ method å…§ï¼š

```java
private void onSaveSuccess(StepContext<?> ctx) {
    log.info("done");
    metrics.counter("SAVE_OK").increment();
    notifyService.send(...);
}
```

å°±ä¹¾æ·¨ã€å¯æ¸¬ã€å¯ç®¡ç†ã€‚

---

## 5.3.3 åŒ¿å lambda çš„å•é¡Œ 3ï¼šstacktrace æ±™æŸ“

åŒ¿å lambda åœ¨ JVM è£¡æœƒè®Šæˆï¼š

```
lambda$doSomething$0
lambda$doSomething$1
```

stacktrace ä¸Šå¾ˆç—›è‹¦ï¼š

- ç„¡æ³•æœå°‹
    
- ç„¡æ³•æº¯æº
    
- ç„¡æ³•å¾—åˆ°è¡Œç‚ºèªæ„
    

å…·åæ–¹æ³•å‰‡æ˜¯ï¼š

```
auditSuccess
handleRecordSave
logValidationFailure
```

å¯è®€æ€§èˆ‡å¯ç¶­è­·æ€§ç›´æ¥æå‡ä¸€å€‹é‡ç´šã€‚

---

## 5.3.4 åŒ¿å lambda çš„å•é¡Œ 4ï¼šå°æ¶æ§‹è¦ç¯„ä¸å‹å–„

ä½ çš„ç³»çµ±æœªä¾†å¯èƒ½å»ºç«‹ï¼š

- å…¨åŸŸå‰¯ä½œç”¨æ””æˆªå™¨ï¼ˆside-effect interceptorï¼‰
    
- äº‹ä»¶è¿½è¹¤ç³»çµ±ï¼ˆevent trailï¼‰
    
- audit æƒæå™¨
    
- behavior å°ç…§è¡¨ï¼ˆmapping è¡Œç‚ºåˆ°å‰¯ä½œç”¨ï¼‰
    

åŒ¿å lambda æœƒè®“é€™äº›å·¥å…·ç„¡æ³•é‹ä½œã€‚

å…·åæ–¹æ³•å‰‡å¤©ç„¶å¯ä»¥è¢«æƒæèˆ‡ç­–ç•¥åŒ–ã€‚

---

# 5.4 æ­£ç¢ºçš„å‰¯ä½œç”¨å¯«æ³•ï¼ˆå…·åæ–¹æ³•ï¼‰

## 5.4.1 æˆåŠŸå‰¯ä½œç”¨

```java
return given(ctx)
    .flatMap(this::writeRecord)
    .peek(this::auditWriteSuccess)
    .peekError(this::auditWriteFailure);
```

æ–¹æ³•ï¼š

```java
private void auditWriteSuccess(StepContext<?> ctx) {
    auditService.success(ctx);
}
```

---

## 5.4.2 éŒ¯èª¤å‰¯ä½œç”¨

```java
.peekError(this::logValidationError)
```

æ–¹æ³•ï¼š

```java
private void logValidationError(Violations v) {
    v.forEach(err -> logger.warn("validation failed: {}", err));
}
```

---

## 5.4.3 ç‰¹æ®Šèªæ„ï¼šsuccess-with-warnings

æ­é…ä½ çš„ `ViolationSeverity`ï¼Œ  
å¯ä»¥åœ¨å‰¯ä½œç”¨ step ä¸­æ±ºå®šè¦ä¸è¦é€šçŸ¥ã€è¦ä¸è¦ fallbackï¼š

```java
private void handleWarnings(StepContext<?> ctx) {
    if (ctx.hasSevereThan(WARNING)) {
        notifyService.warning(ctx);
    }
}
```

---

# 5.5 å‰¯ä½œç”¨çš„ã€ŒæŠ½è±¡å±¤ç´šã€ï¼šä¸æ‡‰æ”¹è®Šä¸»æµç¨‹

å‰¯ä½œç”¨æœ‰ä¸€å€‹å¤§åŸå‰‡ï¼š

> **å‰¯ä½œç”¨ä¸èƒ½æ”¹è®Šä¸»æµç¨‹çš„æˆåŠŸæˆ–å¤±æ•—ç‹€æ…‹ã€‚**

ä¹Ÿå°±æ˜¯èªªï¼š

- **ä¸å¯ä»¥åœ¨å‰¯ä½œç”¨ä¸­å‘¼å« `ctx.addViolation`**
    
- **ä¸å¯ä»¥åœ¨å‰¯ä½œç”¨ä¸­ abort æµç¨‹**
    
- **ä¸å¯ä»¥åœ¨å‰¯ä½œç”¨ä¸­æ”¹è®Š payload**
    

é€™äº›è¡Œç‚ºå±¬æ–¼ã€Œæ¥­å‹™é‚è¼¯ã€ï¼Œå¿…é ˆç§»åˆ° Step è£¡ã€‚

å‰¯ä½œç”¨å”¯ä¸€çš„è²¬ä»»æ˜¯ï¼š

- è¨˜éŒ„
    
- é€šçŸ¥
    
- å ±å‘Š
    
- è¿½è¹¤
    
- çµ±è¨ˆ
    

---

# 5.6 å°‡å‰¯ä½œç”¨å®Œæ•´åˆ†å±¤ï¼ˆæ¶æ§‹èªæ„ï¼‰

ä½ çš„æ¶æ§‹ä¸­å‰¯ä½œç”¨åˆ†ä¸‰å±¤ï¼š

---

### **ï¼ˆ1ï¼‰Domain Side Effectsï¼ˆé ˜åŸŸå‰¯ä½œç”¨ï¼‰**

ä¾‹å¦‚ï¼š

- å¯©è¨ˆ
    
- äº‹ä»¶ï¼ˆdomain eventsï¼‰
    
- é‡è¦ç‹€æ…‹è®Šæ›´é€šçŸ¥
    

é€™äº›é€šå¸¸éœ€è¦å…·åæ–¹æ³•ä¸¦åœ¨ pipeline å¾ŒåŠæ›è¼‰ã€‚

---

### **ï¼ˆ2ï¼‰Infrastructure Side Effectsï¼ˆåŸºç¤å±¤å‰¯ä½œç”¨ï¼‰**

ä¾‹å¦‚ï¼š

- log
    
- metrics
    
- traceId ç¶å®š
    

é€™äº›å¯ä»¥è‡ªå‹•æ›è¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…·åæ–¹æ³•ã€‚

---

### **ï¼ˆ3ï¼‰Behavior Side Effectsï¼ˆé…ç½®åŒ–å‰¯ä½œç”¨ï¼‰**

è‹¥ä½ çš„è¡Œç‚º pipelineï¼ˆBehaviorPipelineï¼‰éœ€è¦ï¼š

- åœ¨æŸå€‹è¦å‰‡æˆåŠŸæ™‚è§¸ç™¼æŸè¡Œç‚º
    
- é…ç½®åŒ– audit/alert
    

ä¹Ÿéœ€è¦å…·åæ–¹æ³•æ‰èƒ½é‹ä½œã€‚

---

# 5.7 å¦‚ä½•åœ¨ BehaviorPipeline ä¸­ä½¿ç”¨å‰¯ä½œç”¨

BehaviorPipeline æœ‰è‡ªå·±çš„ Step å‹åˆ¥ï¼š

```
StepContext<T> -> Validation<Violations, StepContext<T>>
```

åœ¨ BehaviorPipeline è£¡ï¼š

- **æ¥­å‹™é‚è¼¯ Step** åšè³‡æ–™è™•ç†èˆ‡é©—è­‰
    
- **å‰¯ä½œç”¨ Step** åš audit / log / metrics
    

ä¾‹ï¼š

```java
pipeline.addStep(this::calculateQuota)
        .addStep(this::validateRisk)
        .addStep(this::writeRecord)
        .addStep(this::recordAuditEvent);  // å‰¯ä½œç”¨ Step
```

é€™è£¡çš„ `recordAuditEvent` æ˜¯**å…·å Step**ï¼Œè¡¨é”éå¸¸æ˜ç¢ºã€‚

---

# 5.8 CH5 å°çµï¼šå‰¯ä½œç”¨è¨­è¨ˆçš„æ ¸å¿ƒåŸå‰‡

### **ç¬¬ä¸€åŸå‰‡ï¼šå‰¯ä½œç”¨å¿…é ˆå¯è¦‹ï¼ˆvisibleï¼‰**

å…·åæ–¹æ³•æ‰èƒ½è¢«çœ‹è¦‹ã€æœå°‹ã€æ¸¬è©¦ã€æ‹‹å…‰ã€‚

### **ç¬¬äºŒåŸå‰‡ï¼šå‰¯ä½œç”¨ä¸å¾—æ”¹è®Šæµç¨‹èªæ„**

ä¸èƒ½å½±éŸ¿æˆåŠŸ/å¤±æ•—ï¼Œä¸æ‡‰æ”¹è®Š payloadï¼Œä¸æ‡‰æ–°å¢éŒ¯èª¤ã€‚

### **ç¬¬ä¸‰åŸå‰‡ï¼šå‰¯ä½œç”¨èˆ‡ Step å¿…é ˆåˆ†é›¢**

æ¥­å‹™é‚è¼¯ Step èˆ‡å‰¯ä½œç”¨ Step ä¸æ‡‰æ··åœ¨ä¸€èµ·ã€‚

### **ç¬¬å››åŸå‰‡ï¼šåŒ¿å lambda ä¸€å¾‹ç¦æ­¢**

å› ç‚ºå®ƒç ´å£èªæ„ã€å¯è®€æ€§ã€å¯ç¶­è­·æ€§ã€å¯è¿½è¹¤æ€§ã€‚

### **ç¬¬äº”åŸå‰‡ï¼šæ‰€æœ‰å‰¯ä½œç”¨éƒ½æ‡‰ä»¥èªæ„æ–¹æ³•å‘½å**

ä¾‹å¦‚ï¼š

- `auditSuccess`
    
- `auditFailure`
    
- `recordSave`
    
- `logInput`
    
- `sendAlert`
    

åªçœ‹åå­—å°±èƒ½ç†è§£ pipeline é‹ä½œã€‚

---